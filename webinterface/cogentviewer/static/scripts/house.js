// Generated by CoffeeScript 1.3.3
var batteryFormatter, createDlg, dateFormatter, dateNow, dlgCallback, statusFormatter;

require(["dijit/Dialog", "dojo/date"]);

createDlg = function(nodeId) {
  var dlgTitle, theDialog;
  console.log("Creating Dialog");
  dlgTitle = "Register Node " + nodeId;
  theDialog = new dijit.Dialog({
    title: dlgTitle,
    nodeId: nodeId,
    content: "Some Dialog Text can Go Here"
  });
  theDialog.onClose(dlgCallback);
  return theDialog.show();
};

dlgCallback = function() {
  return console.log("Callback");
};

dateNow = new Date();

dateFormatter = function(dateStr) {
  var dateDiff, formatDate, theDate;
  if (dateStr) {
    theDate = dojo.date.stamp.fromISOString(dateStr);
    dateDiff = dojo.date.difference(theDate, dateNow, "hour");
    formatDate = dojo.date.locale.format(theDate, {
      format: "short"
    });
    if (dateDiff > 24) {
      return "<div class='bad'>" + formatDate;
    } else if (dateDiff > 1) {
      return "<div class='middle'>" + formatDate;
    } else {
      return "<div class='good'>" + formatDate;
    }
    return formatDate;
  } else {
    return null;
  }
};

batteryFormatter = function(batteryLevel) {
  if (batteryLevel === null) {
    return "";
  }
  if (batteryLevel > 2.8) {
    return "<div class='good'>" + batteryLevel + "</div>";
  } else if (batteryLevel > 2.4) {
    return "<div class='middle'>" + batteryLevel + "</div>";
  } else {
    return "<div class='bad'>" + batteryLevel + "</div>";
  }
};

statusFormatter = function(theStatus) {
  if (theStatus === "Good") {
    return "<div class='good'>" + theStatus + "</div>";
  } else if (theStatus === "Not Reporting") {
    return "<div class='bad'>" + theStatus + "</div>";
  } else if (theStatus === "Low Battery") {
    return "<div class='middle'>" + theStatus + "</div>";
  }
  return theStatus;
};

require(["dijit/form/Button", "dijit/form/FilteringSelect", "dijit/form/TextBox", "dijit/form/SimpleTextarea", "dijit/form/DateTextBox", "dijit/form/TimeTextBox", "dojo/data/ObjectStore", "dojo/store/Cache", "dojo/store/JsonRest", "dojo/store/Memory", "dojox/grid/DataGrid", "MyWidgets/form/DateTimeBox", "dojo/domReady!"], function(Button, FilterSelect, TextBox, SimpleTextArea, DateTextBox, TimeTextBox, ObjectStore, Cache, jsonRest, Memory, DataGrid, DateTimeBox) {
  var depSelect, deployDataStore, deployStore, edDate, edTime, houseAdd, houseStore, processReset, processSave, resetBtn, saveBtn, stDate, stTime;
  deployStore = jsonRest({
    target: "../rest/deployment/"
  });
  deployDataStore = ObjectStore({
    objectStore: deployStore
  });
  depSelect = new FilterSelect({
    id: "depSelect",
    store: deployStore,
    searchAttr: "name",
    placeholder: "Select a deployment"
  }, "depName");
  depSelect.startup();
  houseAdd = new TextBox({}, "houseAdd");
  stDate = new DateTextBox({}, "stDate");
  stTime = new TimeTextBox({}, "stTime");
  edDate = new DateTextBox({}, "edDate");
  edTime = new TimeTextBox({}, "edTime");
  saveBtn = new Button({
    label: "Save",
    onClick: function() {
      return processSave();
    }
  }, "Save");
  resetBtn = new Button({
    label: "Reset",
    onClick: function() {
      return processReset();
    }
  }, "Reset");
  houseStore = jsonRest({
    target: "../rest/house/"
  });
  if (houseId) {
    houseStore.query({
      id: houseId
    }).then(function(item) {
      var theHouse;
      theHouse = item[0];
      houseAdd.setValue(theHouse.address);
      stDate.setValue(theHouse.startDate);
      edDate.setValue(theHouse.endDate);
      stTime.setValue(theHouse.startDate);
      edTime.setValue(theHouse.endDate);
      return deployStore.query({
        id: theHouse.deploymentId
      }).then(function(depItem) {
        console.log(depItem);
        if (depItem.length > 0) {
          return depSelect.set("displayedValue", depItem[0].name);
        }
      });
    });
  } else {
    console.log("No ID Supplied");
  }
  processSave = function() {
    var endDate, endTime, out, startDate, startTime, theAddress, theDeployment, theItem;
    theDeployment = depSelect.value;
    theAddress = houseAdd.value;
    startDate = stDate.value;
    endDate = edDate.value;
    startTime = stTime.value;
    endTime = edTime.value;
    if (startDate === null || isNaN(startDate.valueOf())) {
      startDate = null;
    }
    if (endDate === null || isNaN(endDate.valueOf())) {
      endDate = null;
    }
    if (startTime === null || isNaN(startTime.valueOf())) {
      startTime = null;
    }
    if (endTime === null || isNaN(endTime.valueOf())) {
      endTime = null;
    }
    if (startDate && startTime) {
      startDate.setHours(startTime.getHours());
      startDate.setMinutes(startTime.getMinutes());
    }
    if (endDate && endTime) {
      endDate.setHours(endTime.getHours());
      endDate.setMinutes(endTime.getMinutes());
    }
    if (houseId) {
      houseStore.query({
        id: houseId
      }).then(function(item) {
        var theHouse;
        theHouse = item[0];
        theHouse.deploymentId = theDeployment;
        theHouse.address = theAddress;
        theHouse.startDate = startDate;
        theHouse.endDate = endDate;
        return houseStore.put(theHouse);
      });
    } else {
      theItem = {
        "deploymentId": theDeployment,
        "address": theAddress,
        "startDate": startDate,
        "endDate": endDate,
        "__table__": "House"
      };
      out = houseStore.put(theItem).then(function(obj) {
        var houseId;
        houseId = obj.id;
        window.location = "" + obj.id;
      });
    }
  };
  processReset = function() {
    console.log("Reset Pressed");
  };
});

require(["dijit/form/Button", "dijit/form/FilteringSelect", "dijit/form/ComboBox", "dijit/form/TextBox", "dijit/form/SimpleTextarea", "dijit/form/DateTextBox", "dijit/form/TimeTextBox", "dijit/form/CheckBox", "dojo/data/ObjectStore", "dojo/store/Cache", "dojo/store/JsonRest", "dojo/store/Memory", "dojox/grid/DataGrid", "dojo/store/Observable", "dojo/_base/Deferred", "dojo/io/script", "dijit/Dialog", "dojo/domReady!"], function(Button, FilterSelect, ComboBox, TextBox, SimpleTextArea, DateTextBox, TimeTextBox, CheckBox, ObjectStore, Cache, jsonRest, Memory, DataGrid, Observable, Deferred, ioScript) {
  var addLocation, cancelNodeBtn, clearNode, houseSelect, houseStore, locationStore, nodeSelect, nodeStore, regNode, regNodeBtn, roomSelect, roomStore, typeStore, updateNodeLocation, updateTimes, updateTimestamps;
  nodeStore = Cache(Observable(jsonRest({
    target: "../rest/node/"
  })), Memory());
  houseStore = Cache(Observable(jsonRest({
    target: "../rest/house/"
  })), Memory());
  roomStore = Cache(Observable(jsonRest({
    target: "../rest/room/"
  })), Memory());
  typeStore = Cache(Observable(jsonRest({
    target: "../rest/roomtype/"
  })), Memory());
  locationStore = Cache(Observable(jsonRest({
    target: "../rest/location/"
  })), Memory());
  nodeSelect = new ComboBox({
    id: "nodeSelect",
    value: "",
    store: nodeStore,
    required: true,
    searchAttr: "id"
  }, "regNodeId");
  houseSelect = new FilterSelect({
    id: "houseSelect",
    value: "",
    store: houseStore,
    searchAttr: "address"
  }, "regNodeHouse");
  if (houseId) {
    houseSelect.setDisabled(true);
  }
  roomSelect = new ComboBox({
    id: "roomSelect",
    value: "",
    store: roomStore,
    required: true,
    storeAttr: "name"
  }, "regNodeRoom");
  updateTimes = new CheckBox({
    id: "updateTimes"
  }, "updateTimes");
  regNodeBtn = new Button({
    label: "Register",
    onClick: function() {
      return regNode();
    }
  }, "dlg_regNode");
  cancelNodeBtn = new Button({
    label: "Cancel",
    onClick: function() {
      return clearNode();
    }
  }, "dlg_regCancel");
  clearNode = function() {
    var theDlg;
    theDlg = dijit.byId("regNodeDialog");
    nodeSelect.setDisabled(false);
    theDlg.reset();
    dijit.byId("regGrid").refresh();
    dijit.byId("statusGrid").refresh();
    return theDlg.hide();
  };
  regNode = function() {
    var theHouse, theNode, theRoom;
    theNode = nodeSelect.value;
    if (houseId) {
      theHouse = houseId;
    } else {
      theHouse = houseSelect.value;
    }
    theRoom = roomSelect.value;
    console.log("N " + theNode + " H " + theHouse + " R " + theRoom);
    if (!dijit.byId("regNodeDialog").validate()) {
      return;
    }
    return roomStore.query({
      name: theRoom
    }).then(function(roomObj) {
      var theObj;
      if (roomObj.length === 0) {
        theObj = {
          "__table__": "Room",
          name: theRoom
        };
        roomStore.add(theObj).then(function(roomId) {
          console.log("New Room Id ", roomId);
          return addLocation(roomId, theNode);
        });
      } else {
        addLocation(roomObj[0].id, theNode);
      }
    });
  };
  addLocation = function(theRoom, theNode) {
    console.log("Setting Up Location for: ", theRoom, " House ", houseId, "  Node: ", theNode);
    locationStore.query({
      houseId: houseId,
      roomId: theRoom
    }).then(function(theLoc) {
      var theObj;
      console.log("Returned Location: ", theLoc);
      if (theLoc.length > 0) {
        return updateNodeLocation(theLoc[0].id, theNode);
      } else {
        theObj = {
          "__table__": "Location",
          houseId: houseId,
          roomId: theRoom
        };
        return locationStore.add(theObj).then(function(newLoc) {
          console.log("New Location ", newLoc);
          return updateNodeLocation(newLoc.id, theNode);
        });
      }
    });
  };
  updateNodeLocation = function(locationId, theNode) {
    console.log("Updating Node " + theNode + " to Location " + locationId);
    return nodeStore.query({
      id: theNode
    }).then(function(storeNode) {
      var theObj;
      console.log("Returned Items from Node Store ", storeNode);
      if (storeNode.length > 0) {
        storeNode = storeNode[0];
        console.log("Node from Store ", storeNode);
        storeNode.locationId = locationId;
        return nodeStore.put(storeNode).then(function(obj) {
          return updateTimestamps(locationId, theNode);
        });
      } else {
        theObj = {
          "__table__": "Node",
          id: theNode,
          locationId: locationId
        };
        console.log("Adding New Node ", theObj);
        return nodeStore.add(theObj).then(function(obj) {
          console.log(obj);
          return updateTimestamps(locationId, theNode);
        });
      }
    });
  };
  return updateTimestamps = function(locationId, theNode) {
    var chkValue;
    console.log(updateTimes);
    chkValue = updateTimes;
    if (chkValue.checked) {
      console.log("Times Need Updating");
      ioScript.get({
        url: "../sumRest/updateTimes/",
        callbackParamName: "callback",
        content: {
          houseId: houseId,
          nodeId: theNode,
          locationId: locationId
        }
      });
    } else {
      console.log("Leaving Times as Be");
    }
    clearNode();
  };
});

require(["dojo/store/Cache", "dojo/store/JsonRest", "dojo/store/Memory", "dojo/store/Observable", "dgrid/OnDemandGrid", "dgrid/Keyboard", "dgrid/Selection", "dgrid/editor", "dgrid/selector", "dojo/_base/declare", "dijit/form/Button", "dgrid/extensions/DijitRegistry", "dijit/Dialog", "dijit/form/FilteringSelect", "dijit/form/ComboBox", "dojo/data/ObjectStore", "dgrid/tree", "dojo/domReady!"], function(Cache, jsonRest, Memory, Observable, OnDemandGrid, Keyboard, Selection, editor, selector, declare, Button, DijitRegistry, Dialog, FilterSelect, ComboBox, ObjectStore, tree) {
  var clearNode, locationStore, nodeStore, procRegister, regNode, registerGrid, registerNode, registerStore, roomStore, statRefresh, statRegister, statusGrid, statusStore, unRegNode, unRegisterNode, updateNode;
  registerStore = Cache(Observable(jsonRest({
    target: "../sumRest/register/"
  })), Memory());
  nodeStore = Cache(Observable(jsonRest({
    target: "../rest/node/"
  })), Memory());
  roomStore = Cache(Observable(jsonRest({
    target: "../rest/room/"
  })), Memory());
  locationStore = Cache(Observable(jsonRest({
    target: "../rest/location/"
  })), Memory());
  statusStore = Cache(Observable(jsonRest({
    target: "../sumRest/status/"
  })), Memory());
  registerStore.getChildren = function(object, options) {
    var theChildren;
    theChildren = this.query({
      parent: object.id
    });
    return theChildren;
  };
  registerGrid = new declare([OnDemandGrid, Keyboard, Selection, DijitRegistry])({
    columns: [
      selector({
        selectorType: "checkbox",
        label: "Select"
      }), {
        label: "id",
        field: "id"
      }, tree({
        label: "Room",
        field: "room"
      }), {
        label: "Type",
        field: "type"
      }, {
        label: "Node",
        field: "node"
      }, {
        label: "Status",
        field: "status",
        formatter: statusFormatter
      }, {
        label: "First Tx",
        field: "firstTx",
        formatter: dateFormatter
      }, {
        label: "Last Tx",
        field: "lastTx",
        formatter: dateFormatter
      }, {
        label: "Total Samples",
        field: "totalSamples"
      }
    ],
    selectorType: "checkbox",
    store: registerStore,
    query: {
      houseId: houseId,
      summary: true
    },
    skin: "claro"
  }, "regGrid");
  registerGrid.styleRow = function(row) {
    return console.log("Styling Row ", row);
  };
  if (!houseId) {
    registerGrid.query.houseId = -1;
    registerGrid.refresh();
  }
  regNode = new Button({
    label: "Register New Node",
    onClick: function() {
      return registerNode();
    }
  }, "regNode");
  unRegNode = new Button({
    label: "Unregister Selected",
    onClick: function() {
      return unRegisterNode();
    }
  }, "unRegNode");
  clearNode = new Button({
    label: "Clear Selection",
    onClick: function() {
      return registerGrid.refresh();
    }
  }, "clearNode");
  updateNode = new Button({
    label: "Update",
    onClick: function() {
      return registerGrid.refresh();
    }
  }, "updateNode");
  registerNode = function() {
    console.log("Register Button Pressed");
    dijit.byId("regNodeDialog").show();
  };
  unRegisterNode = function() {
    var fetchItem, id, row, selected, _results;
    console.log("Unregister Button Pressed");
    selected = registerGrid.selection;
    _results = [];
    for (id in selected) {
      row = registerGrid.row(id).data;
      console.log("ID: ", id, " Row ", row, " Node: ", row.node);
      fetchItem = nodeStore.query({
        id: row.node
      });
      _results.push(fetchItem.then(function(obj) {
        var theNode;
        console.log("Node from Store ", obj);
        theNode = obj[0];
        theNode.locationId = null;
        return nodeStore.put(theNode).then(function(out) {
          return registerGrid.refresh();
        });
      }));
    }
    return _results;
  };
  statusGrid = new declare([OnDemandGrid, Keyboard, Selection, DijitRegistry])({
    columns: [
      editor({
        "label": "Move Node",
        field: "newRoom",
        editorArgs: {
          store: roomStore,
          style: 'width:100px;'
        },
        editor: ComboBox
      }), {
        label: "Node",
        field: "node"
      }, {
        label: "Status",
        field: "status",
        formatter: statusFormatter
      }, {
        label: "Current House",
        field: "currentHouse"
      }, {
        label: "Current Room",
        field: "currentRoom"
      }, {
        label: "Last Tx",
        field: "lastTx",
        formatter: dateFormatter
      }, {
        label: "Voltage",
        field: "voltage",
        formatter: batteryFormatter
      }
    ],
    selectorType: "checkbox",
    store: statusStore,
    query: {
      cutTime: 30
    }
  }, "statusGrid");
  statusGrid.on("dgrid-datachange", function(evt) {
    console.log("Data changed: ", evt);
    return evt.cell.row.data.houseId = houseId;
  });
  statRegister = new Button({
    label: "Register Selected",
    onClick: function() {
      return procRegister();
    }
  }, "statRegister");
  statRefresh = new Button({
    label: "Refresh",
    onClick: function() {
      return statusGrid.refresh();
    }
  }, "statRefresh");
  procRegister = function() {
    return statusGrid.save();
  };
});
